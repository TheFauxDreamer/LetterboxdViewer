<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letterboxd Archive Dashboard</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/cal-heatmap.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/cal-heatmap/dist/cal-heatmap.css">
    
    <style>
        :root {
            --bg: #14181c;
            --card-bg: #1b2228;
            --border: #2c3440;
            --text-main: #9ab;
            --text-bright: #fff;
            --lb-green: #00e054;
            --container-width: 1000px;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: var(--container-width); margin: auto; display: flex; flex-direction: column; }

        .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 25px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 6px; text-align: center; border: 1px solid var(--border); }
        .stat-box h2 { color: var(--text-bright); margin: 5px 0 0 0; font-size: 24px; }
        .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }

        #heatmap-scroll-container { 
            background: var(--card-bg);
            padding: 25px; 
            border-radius: 8px; 
            margin-bottom: 30px; 
            overflow-x: auto; 
            border: 1px solid var(--border);
            width: 100%;
            box-sizing: border-box;
        }

        .ch-domain-text { fill: var(--text-main) !important; font-size: 12px !important; }
        rect.ch-subdomain-bg { fill: #242c34; }
        rect.ch-subdomain-bg[data-value] { fill: inherit; }

        .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 30px; }
        h3 { color: var(--text-bright); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 0; }

        .recent-column { position: relative; }
        
        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: default;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 12px;
        }
        
        .recent-header h3 {
            border: none;
            padding: 0;
            margin: 0;
        }
        
        .recent-chevron {
            display: none;
            transition: transform 0.3s ease;
        }
        
        .recent-chevron.collapsed {
            transform: rotate(-90deg);
        }
        
        .carousel-container {
            display: none; /* Hidden by default, shown on mobile */
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .carousel-track {
            display: flex;
            transition: transform 0.3s ease;
        }
        
        .carousel-item {
            min-width: 100%;
            flex-shrink: 0;
        }
        
        .carousel-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .carousel-dot.active {
            background: var(--lb-green);
            width: 24px;
            border-radius: 4px;
        }
        
        .carousel-arrows {
            display: flex;
            justify-content: space-between;
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 10;
        }
        
        .carousel-arrow {
            background: rgba(0, 224, 84, 0.9);
            border: none;
            color: var(--bg);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            pointer-events: all;
            margin: 0 10px;
        }
        
        .carousel-arrow:active {
            transform: scale(0.95);
        }

        .movie-row { display: flex; gap: 12px; background: var(--card-bg); border-radius: 4px; margin-bottom: 12px; overflow: hidden; border: 1px solid var(--border); align-items: flex-start; }
        .movie-row img { width: 60px; height: 90px; object-fit: cover; display: block; background: #2c3440; flex-shrink: 0; }
        .movie-info { padding: 10px 10px 10px 0; flex-grow: 1; }
        .movie-info h4 { margin: 0; color: var(--text-bright); font-size: 14px; line-height: 1.3; }
        .stars { color: var(--lb-green); font-size: 16px; margin-top: 4px; display: block; }

        .review-box { 
            font-size: 13px; color: #cbd5e0; line-height: 1.6; font-style: italic; 
            border-left: 2px solid var(--lb-green); padding-left: 12px; margin-top: 10px;
            white-space: pre-wrap; word-wrap: break-word;
        }

        .rewatch-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 224, 84, 0.1);
            border: 1px solid rgba(0, 224, 84, 0.3);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            color: var(--lb-green);
            margin-left: 6px;
            vertical-align: middle;
        }
        .rewatch-badge svg {
            width: 12px;
            height: 12px;
            flex-shrink: 0;
        }
        .rewatch-count {
            font-weight: 600;
            font-size: 10px;
        }
        
        .detail-column { background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border); min-height: 400px; }
        .detail-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; }
        .detail-header h3 { border: none; padding: 0; margin: 0; }
        .day-nav { display: flex; gap: 8px; }
        .day-nav button { background: var(--card-bg); border: 1px solid var(--border); color: var(--text-main); width: 32px; height: 32px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s; }
        .day-nav button:hover { background: var(--border); color: var(--text-bright); }
        .detail-date { color: var(--lb-green); font-weight: bold; }
        .empty-msg { color: #678; font-style: italic; margin-top: 40px; text-align: center; font-size: 1.1rem; }

        #heatmap-scroll-container::-webkit-scrollbar { height: 8px; }
        #heatmap-scroll-container::-webkit-scrollbar-track { background: var(--bg); }
        #heatmap-scroll-container::-webkit-scrollbar-thumb { background: #456; border-radius: 10px; }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-row h1 { margin: 0; font-size: 24px; }
        .wrapped-btn { background: var(--lb-green); color: var(--bg); border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .wrapped-btn:hover { background: #00c047; transform: translateY(-1px); }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 25px 30px; border-bottom: 1px solid var(--border); }
        .modal-header h2 { margin: 0; color: var(--text-bright); font-size: 28px; }
        .modal-close { background: transparent; border: none; color: var(--text-main); font-size: 32px; cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px; }
        .modal-close:hover { color: var(--text-bright); }
        .modal-body { padding: 30px; }
        
        .year-selector { display: flex; gap: 8px; margin-bottom: 30px; flex-wrap: wrap; }
        .year-btn { background: var(--card-bg); border: 1px solid var(--border); color: var(--text-main); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .year-btn:hover { background: var(--border); color: var(--text-bright); }
        .year-btn.active { background: var(--lb-green); color: var(--bg); border-color: var(--lb-green); }

        .wrapped-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .wrapped-stat-box { background: rgba(0, 224, 84, 0.05); border: 1px solid rgba(0, 224, 84, 0.2); padding: 20px; border-radius: 8px; }
        .wrapped-stat-box h3 { margin: 0 0 5px 0; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-main); }
        .wrapped-stat-box .value { font-size: 24px; color: var(--text-bright); font-weight: 600; margin-bottom: 5px; min-height: 32px; }
        .wrapped-stat-box .subtitle { font-size: 12px; color: #678; }
        
        .rotating-title {
            animation: fadeInOut 3s ease-in-out infinite;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .rating-chart { margin-top: 30px; }
        .rating-chart h3 { color: var(--text-bright); margin-bottom: 20px; }
        .chart-bar { display: flex; align-items: center; margin-bottom: 12px; }
        .chart-label { width: 80px; color: var(--text-main); font-size: 14px; }
        .chart-bar-wrapper { flex: 1; background: #242c34; height: 30px; border-radius: 4px; position: relative; overflow: hidden; }
        .chart-bar-fill { background: var(--lb-green); height: 100%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; }
        .chart-bar-count { color: var(--bg); font-weight: 600; font-size: 13px; }

        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: var(--bg); }
        .modal-content::-webkit-scrollbar-thumb { background: #456; border-radius: 10px; }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            body { 
                padding: 10px; 
                overflow-x: hidden;
            }
            
            .container {
                overflow-x: hidden;
            }
            
            .header-row { 
                flex-direction: column; 
                gap: 15px; 
                align-items: stretch;
            }
            
            .header-row h1 { 
                font-size: 20px; 
                text-align: center;
            }
            
            .wrapped-btn {
                width: 100%;
                padding: 12px 20px;
            }
            
            .stats-bar { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 8px;
                margin-bottom: 20px;
                width: 100%;
            }
            
            .stat-box { 
                padding: 12px; 
            }
            
            .stat-box h2 { 
                font-size: 20px; 
            }
            
            .stat-label { 
                font-size: 10px; 
            }
            
            #heatmap-scroll-container {
                padding: 15px;
                margin-bottom: 20px;
                margin-left: -10px;
                margin-right: -10px;
                width: calc(100% + 20px);
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            
            .main-layout { 
                grid-template-columns: 1fr; 
                gap: 20px;
                width: 100%;
            }
            
            .recent-column, .detail-column {
                width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }
            
            .recent-header {
                cursor: pointer;
                user-select: none;
                padding-bottom: 12px;
            }
            
            .recent-header h3 {
                font-size: 16px;
            }
            
            .recent-chevron {
                display: block;
                font-size: 20px;
                color: var(--lb-green);
            }
            
            .recent-watches-content {
                transition: max-height 0.3s ease, opacity 0.3s ease;
                overflow: hidden;
                max-height: 1000px; /* Large enough for content */
            }
            
            .recent-watches-content.collapsed {
                max-height: 0 !important;
                opacity: 0;
                margin: 0;
                padding: 0;
            }
            
            /* Show carousel on mobile */
            .carousel-container {
                display: block;
                width: 100%;
                box-sizing: border-box;
            }
            
            /* Hide carousel arrows on mobile */
            .carousel-arrows {
                display: none;
            }
            
            /* Hide regular list on mobile */
            #recent-posters-list {
                display: none;
            }
            
            .detail-column {
                padding: 15px;
                width: 100%;
                box-sizing: border-box;
            }
            
            .movie-row {
                width: 100%;
                box-sizing: border-box;
            }
            
            .movie-info {
                overflow: hidden;
                width: 100%;
            }
            
            .movie-info h4 {
                overflow-wrap: break-word;
                word-wrap: break-word;
            }
            
            .detail-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .detail-header h3 {
                text-align: center;
                font-size: 16px;
            }
            
            .day-nav {
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
                max-height: 85vh;
            }
            
            .modal-header {
                padding: 20px;
            }
            
            .modal-header h2 {
                font-size: 22px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .wrapped-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .wrapped-stat-box {
                padding: 15px;
            }
            
            .wrapped-stat-box .value {
                font-size: 20px;
            }
            
            .chart-label {
                width: 60px;
                font-size: 12px;
            }
            
            .year-selector {
                gap: 6px;
            }
            
            .year-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .review-box {
                overflow-wrap: break-word;
                word-break: break-word;
            }
        }
        
        /* Desktop: hide carousel, show list */
        @media (min-width: 769px) {
            .carousel-container {
                display: none;
            }
            
            #recent-posters-list {
                display: block;
            }
            
            .recent-header {
                cursor: default;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-row">
            <h1 id="username-header">loading's Letterboxd</h1>
            <button class="wrapped-btn" onclick="openWrapped()">View Your Wrapped</button>
        </div>
        <div class="stats-bar">
            <div class="stat-box"><div class="stat-label">Watched this Week</div><h2 id="w-val">0</h2></div>
            <div class="stat-box"><div class="stat-label">Watched this Month</div><h2 id="m-val">0</h2></div>
            <div class="stat-box"><div class="stat-label">Watched this Year</div><h2 id="y-val">0</h2></div>
            <div class="stat-box"><div class="stat-label">All Time Total</div><h2 id="t-val">0</h2></div>
        </div>

        <div id="heatmap-scroll-container">
            <div id="cal-heatmap"></div>
        </div>

        <div class="main-layout">
            <div class="recent-column">
                <div class="recent-header" onclick="toggleRecentWatches()">
                    <h3>Recent Watches</h3>
                    <span class="recent-chevron" id="recent-chevron">▼</span>
                </div>
                
                <div class="recent-watches-content" id="recent-watches-content">
                    <!-- Desktop: Regular list -->
                    <div id="recent-posters-list"></div>
                    
                    <!-- Mobile: Carousel -->
                    <div class="carousel-container">
                        <div class="carousel-arrows">
                            <button class="carousel-arrow" onclick="moveCarousel(-1)">‹</button>
                            <button class="carousel-arrow" onclick="moveCarousel(1)">›</button>
                        </div>
                        <div class="carousel-track" id="carousel-track"></div>
                        <div class="carousel-controls" id="carousel-dots"></div>
                    </div>
                </div>
            </div>
            <div class="detail-column">
                <div class="detail-header">
                    <h3>Activity on <span id="view-date" class="detail-date">...</span></h3>
                    <div class="day-nav">
                        <button id="prev-day" title="Previous day">‹</button>
                        <button id="next-day" title="Next day">›</button>
                    </div>
                </div>
                <div id="day-list"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="wrapped-modal" onclick="closeWrappedOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Your Year in Film</h2>
                <button class="modal-close" onclick="closeWrapped()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="year-selector" id="year-selector"></div>
                <div id="wrapped-content"></div>
            </div>
        </div>
    </div>

    <script>
        let allMovies = [];
        let currentViewDate = new Date();
        let movieWatchHistory = {}; // Track all watch dates per movie
        let wrappedStats = {}; // Store wrapped statistics
        let rotationIntervals = {}; // Store rotation interval IDs
        let carouselIndex = 0;
        let carouselMovies = [];
        let carouselAutoRotate = null; // Auto-rotation interval
        let recentWatchesExpanded = true; // Track if recent watches is expanded on mobile

        function openWrapped() {
            document.getElementById('wrapped-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            // Stop carousel auto-rotation when modal opens
            if (carouselAutoRotate) {
                clearInterval(carouselAutoRotate);
                carouselAutoRotate = null;
            }
            
            // Default to current year, or most recent year with data, or all time
            const currentYear = new Date().getFullYear();
            const years = Object.keys(wrappedStats).filter(k => k !== 'allTime').sort((a, b) => b - a);
            
            let defaultYear;
            if (wrappedStats[currentYear] && wrappedStats[currentYear].movies.length > 0) {
                defaultYear = currentYear;
            } else if (years.length > 0) {
                defaultYear = parseInt(years[0]); // Most recent year with data
            } else {
                defaultYear = 'allTime';
            }
            
            generateWrapped(defaultYear);
        }

        function closeWrapped() {
            document.getElementById('wrapped-modal').classList.remove('active');
            document.body.style.overflow = 'auto';
            // Clear all rotation intervals
            Object.values(rotationIntervals).forEach(interval => clearInterval(interval));
            rotationIntervals = {};
            // Restart carousel auto-rotation when modal closes
            startCarouselAutoRotate();
        }

        function closeWrappedOnOverlay(event) {
            if (event.target.id === 'wrapped-modal') {
                closeWrapped();
            }
        }

        function parseRating(ratingStr) {
            if (!ratingStr || ratingStr.trim() === '') return 0; // No rating = 0
            const stars = (ratingStr.match(/★/g) || []).length;
            const halfStars = (ratingStr.match(/½/g) || []).length;
            return stars + (halfStars * 0.5);
        }

        function calculateWrappedStats() {
            wrappedStats = { allTime: { movies: [], years: new Set() } };
            
            allMovies.forEach(movie => {
                const year = movie.date.getFullYear();
                
                // Initialize year if needed
                if (!wrappedStats[year]) {
                    wrappedStats[year] = { movies: [] };
                }
                
                wrappedStats[year].movies.push(movie);
                wrappedStats.allTime.movies.push(movie);
                wrappedStats.allTime.years.add(year);
            });

            // Calculate stats for each year and all time
            Object.keys(wrappedStats).forEach(key => {
                if (key === 'allTime') return;
                calculateYearStats(wrappedStats[key]);
            });
            calculateYearStats(wrappedStats.allTime);
        }

        function calculateYearStats(stats) {
            stats.totalWatches = stats.movies.length;
            
            // Most watched movie
            const movieCounts = {};
            stats.movies.forEach(m => {
                movieCounts[m.filmTitle] = (movieCounts[m.filmTitle] || 0) + 1;
            });
            const mostWatchedEntry = Object.entries(movieCounts).sort((a, b) => b[1] - a[1])[0];
            // Only set mostWatched if a movie was watched more than once
            stats.mostWatched = (mostWatchedEntry && mostWatchedEntry[1] > 1) ? { title: mostWatchedEntry[0], count: mostWatchedEntry[1] } : null;

            // Highest and lowest rated - find ALL movies with those ratings
            const ratedMovies = stats.movies.map(m => ({
                ...m,
                numericRating: parseRating(m.rating)
            }));

            if (ratedMovies.length > 0) {
                // Find highest rating value
                const maxRating = Math.max(...ratedMovies.map(m => m.numericRating));
                stats.highestRated = ratedMovies.filter(m => m.numericRating === maxRating && maxRating > 0);
                
                // Find lowest rating value (including 0)
                const minRating = Math.min(...ratedMovies.map(m => m.numericRating));
                stats.lowestRated = ratedMovies.filter(m => m.numericRating === minRating);
            } else {
                stats.highestRated = [];
                stats.lowestRated = [];
            }

            // Rating distribution
            stats.ratingDistribution = {};
            [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5].forEach(rating => {
                stats.ratingDistribution[rating] = 0;
            });
            
            ratedMovies.forEach(m => {
                if (stats.ratingDistribution[m.numericRating] !== undefined) {
                    stats.ratingDistribution[m.numericRating]++;
                }
            });
        }

        function startRotation(elementId, items, getRatingFunc) {
            if (items.length <= 1) return; // No need to rotate if only one item
            
            let currentIndex = 0;
            const element = document.getElementById(elementId);
            const subtitleElement = element.parentElement.querySelector('.subtitle');
            
            const rotate = () => {
                currentIndex = (currentIndex + 1) % items.length;
                element.textContent = items[currentIndex].title;
                element.classList.add('rotating-title');
                if (subtitleElement) {
                    subtitleElement.textContent = getRatingFunc(items[currentIndex]);
                }
            };
            
            // Rotate every 3 seconds
            const intervalId = setInterval(rotate, 3000);
            rotationIntervals[elementId] = intervalId;
        }

        function generateWrapped(selectedYear) {
            // Clear existing intervals
            Object.values(rotationIntervals).forEach(interval => clearInterval(interval));
            rotationIntervals = {};
            
            const years = Object.keys(wrappedStats).filter(k => k !== 'allTime').sort((a, b) => b - a);
            
            // Generate year selector
            const yearSelector = document.getElementById('year-selector');
            yearSelector.innerHTML = `
                <button class="year-btn ${selectedYear === 'allTime' ? 'active' : ''}" onclick="generateWrapped('allTime')">All Time</button>
                ${years.map(year => `
                    <button class="year-btn ${selectedYear == year ? 'active' : ''}" onclick="generateWrapped(${year})">${year}</button>
                `).join('')}
            `;

            // Get stats for selected year
            const stats = wrappedStats[selectedYear] || wrappedStats.allTime;
            
            // Generate content
            const content = document.getElementById('wrapped-content');
            const maxRatingCount = Math.max(...Object.values(stats.ratingDistribution));
            
            const highestTitle = stats.highestRated.length > 0 ? stats.highestRated[0].title : 'N/A';
            const highestRating = stats.highestRated.length > 0 ? stats.highestRated[0].rating : '';
            const highestCount = stats.highestRated.length;
            
            const lowestTitle = stats.lowestRated.length > 0 ? stats.lowestRated[0].title : 'N/A';
            const lowestRating = stats.lowestRated.length > 0 ? stats.lowestRated[0].rating || '(unrated)' : '';
            const lowestCount = stats.lowestRated.length;
            
            content.innerHTML = `
                <div class="wrapped-stats">
                    <div class="wrapped-stat-box">
                        <h3>Total Watches</h3>
                        <div class="value">${stats.totalWatches}</div>
                        <div class="subtitle">${selectedYear === 'allTime' ? 'Across all years' : 'This year'}</div>
                    </div>
                    
                    <div class="wrapped-stat-box">
                        <h3>Most Watched</h3>
                        <div class="value">${stats.mostWatched ? stats.mostWatched.title : 'N/A'}</div>
                        <div class="subtitle">${stats.mostWatched ? `${stats.mostWatched.count} times` : 'You didn\'t have any stand outs'}</div>
                    </div>
                    
                    <div class="wrapped-stat-box">
                        <h3>Highest Rated</h3>
                        <div class="value" id="highest-rated-title">${highestTitle}</div>
                        <div class="subtitle">${highestRating}${highestCount > 1 ? ` (${highestCount} movies)` : ''}</div>
                    </div>
                    
                    <div class="wrapped-stat-box">
                        <h3>Lowest Rated</h3>
                        <div class="value" id="lowest-rated-title">${lowestTitle}</div>
                        <div class="subtitle">${lowestRating}${lowestCount > 1 ? ` (${lowestCount} movies)` : ''}</div>
                    </div>
                </div>

                <div class="rating-chart">
                    <h3>Rating Distribution</h3>
                    ${[5, 4.5, 4, 3.5, 3, 2.5, 2, 1.5, 1, 0.5, 0].map(rating => {
                        const count = stats.ratingDistribution[rating] || 0;
                        const percentage = maxRatingCount > 0 ? (count / maxRatingCount) * 100 : 0;
                        let stars;
                        if (rating === 0) {
                            stars = 'No rating';
                        } else {
                            stars = '★'.repeat(Math.floor(rating)) + (rating % 1 ? '½' : '');
                        }
                        return `
                            <div class="chart-bar">
                                <div class="chart-label">${stars}</div>
                                <div class="chart-bar-wrapper">
                                    <div class="chart-bar-fill" style="width: ${percentage}%">
                                        ${count > 0 ? `<span class="chart-bar-count">${count}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Start rotations after content is rendered
            setTimeout(() => {
                if (stats.highestRated.length > 1) {
                    startRotation('highest-rated-title', stats.highestRated, (movie) => {
                        return `${movie.rating}${highestCount > 1 ? ` (${highestCount} movies)` : ''}`;
                    });
                }
                if (stats.lowestRated.length > 1) {
                    startRotation('lowest-rated-title', stats.lowestRated, (movie) => {
                        return `${movie.rating || '(unrated)'}${lowestCount > 1 ? ` (${lowestCount} movies)` : ''}`;
                    });
                }
            }, 100);
        }

        function getRewatchBadge(watchNumber) {
            if (watchNumber === 1) return ''; // First watch, no badge
            
            const icon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
            </svg>`;
            
            if (watchNumber === 2) {
                return `<span class="rewatch-badge" title="Rewatch">${icon}</span>`;
            } else {
                const rewatchCount = watchNumber - 1;
                return `<span class="rewatch-badge" title="Rewatch #${rewatchCount}">${icon}<span class="rewatch-count">×${rewatchCount}</span></span>`;
            }
        }

        function formatDate(dateObj) {
            const d = String(dateObj.getDate()).padStart(2, '0');
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const y = dateObj.getFullYear();
            return `${d}/${m}/${y}`;
        }

        function scrollToRight() {
            const container = document.getElementById('heatmap-scroll-container');
            if (container) container.scrollLeft = container.scrollWidth;
        }

        function updateDetailView(dateObj, isoOverride = null) {
            // Use ISO override if provided to avoid timezone issues
            const iso = isoOverride || dateObj.toISOString().split('T')[0];
            currentViewDate = new Date(iso + 'T12:00:00'); // Use noon to avoid timezone issues
            
            const dayMovies = allMovies.filter(m => m.iso === iso);
            document.getElementById('view-date').innerText = formatDate(currentViewDate);
            const list = document.getElementById('day-list');
            
            if (dayMovies.length > 0) {
                list.innerHTML = dayMovies.map(m => `
                    <div class="movie-row" style="background:transparent; border:none; border-bottom:1px solid #333; border-radius:0; margin-bottom:20px; padding-bottom:10px;">
                        <img src="${m.poster}" onerror="this.src='https://via.placeholder.com/60x90?text=?'" style="border-radius:4px; border:1px solid var(--border);">
                        <div class="movie-info">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${m.title}${getRewatchBadge(m.watchNumber)}</strong><span class="stars">${m.rating}</span>
                            </div>
                            <div class="review-box">${m.review || 'No review logged.'}</div>
                        </div>
                    </div>`).join('');
            } else {
                list.innerHTML = `<div class="empty-msg">No movies have been watched & reviewed today. <br><br> Yet...</div>`;
            }
        }

        function navigateDay(direction) {
            // Get all unique dates that have movies, sorted
            const datesWithMovies = [...new Set(allMovies.map(m => m.iso))].sort();
            
            if (datesWithMovies.length === 0) return;
            
            // Find current date in the list
            const currentIso = currentViewDate.toISOString().split('T')[0];
            const currentIndex = datesWithMovies.indexOf(currentIso);
            
            let targetIndex;
            if (currentIndex === -1) {
                // Current date has no movies, find closest date with movies
                if (direction === 1) {
                    // Find next date with movies
                    targetIndex = datesWithMovies.findIndex(d => d > currentIso);
                    if (targetIndex === -1) targetIndex = datesWithMovies.length - 1; // Wrap to last
                } else {
                    // Find previous date with movies
                    targetIndex = datesWithMovies.slice().reverse().findIndex(d => d < currentIso);
                    if (targetIndex === -1) targetIndex = 0; // Wrap to first
                    else targetIndex = datesWithMovies.length - 1 - targetIndex;
                }
            } else {
                // Current date has movies, move to next/prev date with movies
                targetIndex = currentIndex + direction;
                
                // Handle boundaries
                if (targetIndex < 0) targetIndex = 0;
                if (targetIndex >= datesWithMovies.length) targetIndex = datesWithMovies.length - 1;
            }
            
            // Pass the ISO string directly to avoid timezone conversion issues
            const targetIso = datesWithMovies[targetIndex];
            const targetDate = new Date(targetIso + 'T12:00:00');
            updateDetailView(targetDate, targetIso);
        }

        function toggleRecentWatches() {
            // Only toggle on mobile
            if (window.innerWidth > 768) return;
            
            recentWatchesExpanded = !recentWatchesExpanded;
            const content = document.getElementById('recent-watches-content');
            const chevron = document.getElementById('recent-chevron');
            
            if (recentWatchesExpanded) {
                content.classList.remove('collapsed');
                chevron.classList.remove('collapsed');
                // Resume carousel auto-rotation if expanded
                startCarouselAutoRotate();
            } else {
                content.classList.add('collapsed');
                chevron.classList.add('collapsed');
                // Pause carousel auto-rotation if collapsed
                if (carouselAutoRotate) {
                    clearInterval(carouselAutoRotate);
                    carouselAutoRotate = null;
                }
            }
        }

        function goToCarouselSlide(index) {
            carouselIndex = index;
            updateCarousel();
            
            // Restart auto-rotation
            if (carouselAutoRotate) {
                clearInterval(carouselAutoRotate);
                if (carouselMovies.length > 1) {
                    carouselAutoRotate = setInterval(() => {
                        carouselIndex = (carouselIndex + 1) % carouselMovies.length;
                        updateCarousel();
                    }, 5000);
                }
            }
        }

        function moveCarousel(direction) {
            carouselIndex += direction;
            
            // Wrap around
            if (carouselIndex < 0) carouselIndex = carouselMovies.length - 1;
            if (carouselIndex >= carouselMovies.length) carouselIndex = 0;
            
            updateCarousel();
            
            // Restart auto-rotation timer when manually navigated
            if (carouselAutoRotate) {
                clearInterval(carouselAutoRotate);
                if (carouselMovies.length > 1) {
                    carouselAutoRotate = setInterval(() => {
                        carouselIndex = (carouselIndex + 1) % carouselMovies.length;
                        updateCarousel();
                    }, 5000);
                }
            }
        }

        function startCarouselAutoRotate() {
            // Clear existing interval
            if (carouselAutoRotate) {
                clearInterval(carouselAutoRotate);
            }
            
            // Only auto-rotate if there are multiple items
            if (carouselMovies.length > 1) {
                carouselAutoRotate = setInterval(() => {
                    carouselIndex = (carouselIndex + 1) % carouselMovies.length;
                    updateCarousel();
                }, 5000); // Rotate every 5 seconds
            }
        }

        function updateCarousel() {
            const track = document.getElementById('carousel-track');
            track.style.transform = `translateX(-${carouselIndex * 100}%)`;
            
            // Update dots
            const dots = document.querySelectorAll('.carousel-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === carouselIndex);
            });
        }

        function renderCarousel(movies) {
            carouselMovies = movies;
            const track = document.getElementById('carousel-track');
            const dotsContainer = document.getElementById('carousel-dots');
            
            track.innerHTML = movies.map(m => `
                <div class="carousel-item">
                    <div class="movie-row">
                        <img src="${m.poster}" onerror="this.src='https://via.placeholder.com/60x90?text=?'">
                        <div class="movie-info">
                            <h4>${m.title}${getRewatchBadge(m.watchNumber)}</h4><span class="stars">${m.rating}</span>
                            <small style="font-size:10px; color:#678">${formatDate(m.date)}</small>
                        </div>
                    </div>
                </div>
            `).join('');
            
            dotsContainer.innerHTML = movies.map((_, index) => 
                `<div class="carousel-dot ${index === 0 ? 'active' : ''}" onclick="goToCarouselSlide(${index})"></div>`
            ).join('');
            
            carouselIndex = 0;
            
            // Add touch support
            let touchStartX = 0;
            let touchEndX = 0;
            
            track.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            track.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                if (touchStartX - touchEndX > 50) {
                    moveCarousel(1);
                } else if (touchEndX - touchStartX > 50) {
                    moveCarousel(-1);
                }
            });
            
            // Start auto-rotation
            startCarouselAutoRotate();
        }

        async function init() {
            try {
                const resp = await fetch('my_history.xml');
                const text = await resp.text();
                const xml = new window.DOMParser().parseFromString(text, "text/xml");
                const items = xml.querySelectorAll("item");
                const now = new Date();
                let dailyCounts = {};
                let stats = { w: 0, m: 0, y: 0 };
                let oldestDate = new Date();

                // Extract username from first item's link
                if (items.length > 0) {
                    const firstLink = items[0].querySelector("link").textContent;
                    const usernameMatch = firstLink.match(/letterboxd\.com\/([^\/]+)\//);
                    if (usernameMatch) {
                        const username = usernameMatch[1];
                        document.getElementById('username-header').textContent = `${username}'s Letterboxd`;
                    }
                }

                allMovies = [];

                items.forEach(item => {
                    const rawTitle = item.querySelector("title").textContent;
                    
                    // Use watchedDate instead of pubDate
                    const watchedDateNode = Array.from(item.childNodes).find(n => n.nodeName.includes('watchedDate'));
                    const watchedDate = watchedDateNode ? new Date(watchedDateNode.textContent) : new Date(item.querySelector("pubDate").textContent);
                    
                    const iso = watchedDate.toISOString().split('T')[0];
                    if (watchedDate < oldestDate) oldestDate = watchedDate;

                    const posterNode = Array.from(item.childNodes).find(n => n.nodeName.includes('poster'));
                    const poster = posterNode ? posterNode.textContent : "";
                    const reviewNode = Array.from(item.childNodes).find(n => n.nodeName.includes('review'));
                    const review = reviewNode ? reviewNode.textContent : "";
                    
                    // Get film title
                    const filmTitleNode = Array.from(item.childNodes).find(n => n.nodeName.includes('filmTitle'));
                    const filmTitle = filmTitleNode ? filmTitleNode.textContent : "";
                    
                    // Track watch history per movie
                    if (!movieWatchHistory[filmTitle]) {
                        movieWatchHistory[filmTitle] = [];
                    }
                    movieWatchHistory[filmTitle].push({ date: watchedDate, iso });
                    
                    // Extract rating (everything after "YEAR - ")
                    const ratingMatch = rawTitle.match(/\d{4}\s*-\s*(.+)$/);
                    const stars = ratingMatch ? ratingMatch[1].trim() : "";
                    const cleanTitle = rawTitle.split(/, \s*(?=\d{4})/)[0];
                    
                    allMovies.push({ title: cleanTitle, rating: stars, iso, poster, review, date: watchedDate, filmTitle });
                    dailyCounts[iso] = (dailyCounts[iso] || 0) + 1;

                    const diffDays = (now - watchedDate) / 86400000;
                    if (diffDays <= 7) stats.w++;
                    if (watchedDate.getMonth() === now.getMonth() && watchedDate.getFullYear() === now.getFullYear()) stats.m++;
                    if (watchedDate.getFullYear() === now.getFullYear()) stats.y++;
                });

                // Sort watch history for each movie chronologically
                Object.keys(movieWatchHistory).forEach(filmTitle => {
                    movieWatchHistory[filmTitle].sort((a, b) => a.date - b.date);
                });

                // Assign watch numbers to each movie entry
                allMovies.forEach(movie => {
                    const watches = movieWatchHistory[movie.filmTitle];
                    movie.watchNumber = watches.findIndex(w => w.iso === movie.iso && w.date.getTime() === movie.date.getTime()) + 1;
                });

                allMovies.sort((a, b) => b.date - a.date);

                document.getElementById('w-val').innerText = stats.w;
                document.getElementById('m-val').innerText = stats.m;
                document.getElementById('y-val').innerText = stats.y;
                document.getElementById('t-val').innerText = allMovies.length;

                renderRecent(allMovies.slice(0, 3));
                
                const heatmapData = Object.keys(dailyCounts).map(date => ({
                    date: date,
                    value: dailyCounts[date]
                }));

                renderHeatmap(heatmapData, oldestDate, now);
                updateDetailView(now);
                calculateWrappedStats();
            } catch (err) { console.error(err); }
        }

        function renderRecent(movies) {
            // Desktop list
            document.getElementById('recent-posters-list').innerHTML = movies.map(m => `
                <div class="movie-row">
                    <img src="${m.poster}" onerror="this.src='https://via.placeholder.com/60x90?text=?'">
                    <div class="movie-info">
                        <h4>${m.title}${getRewatchBadge(m.watchNumber)}</h4><span class="stars">${m.rating}</span>
                        <small style="font-size:10px; color:#678">${formatDate(m.date)}</small>
                    </div>
                </div>`).join('');
            
            // Mobile carousel
            renderCarousel(movies);
        }

        function renderHeatmap(data, start, now) {
            const endDate = new Date(now);
            endDate.setMonth(endDate.getMonth() + 3); // Show 3 months ahead
            const totalMonths = (endDate.getFullYear() - start.getFullYear()) * 12 + (endDate.getMonth() - start.getMonth()) + 1;
            const cal = new CalHeatmap();
            
            const observer = new ResizeObserver(() => scrollToRight());
            observer.observe(document.getElementById('heatmap-scroll-container'));

            cal.paint({
                itemSelector: '#cal-heatmap',
                data: { source: data, x: 'date', y: 'value' },
                range: totalMonths, 
                date: { start: new Date(start.getFullYear(), start.getMonth(), 1) },
                domain: { 
                    type: 'month', 
                    gutter: 15,
                    label: { 
                        text: function(timestamp) {
                            const date = new Date(timestamp);
                            const month = date.toLocaleString('default', { month: 'short' });
                            // Show year for January
                            if (date.getMonth() === 0) {
                                return month + " '" + date.getFullYear().toString().slice(-2);
                            }
                            return month;
                        }
                    }
                }, 
                subDomain: { type: 'day', radius: 2, gutter: 4, width: 12, height: 12 },
                scale: { 
                    color: { 
                        type: 'threshold', 
                        range: ['#242c34', '#1e4620', '#2ea043', '#39d353', '#00e054'],
                        domain: [0.5, 1.5, 2.5, 3.5] 
                    } 
                }
            });

            cal.on('click', (event, timestamp) => {
                updateDetailView(new Date(timestamp));
                
                // On mobile, collapse recent watches section to show activity
                if (window.innerWidth <= 768 && recentWatchesExpanded) {
                    toggleRecentWatches();
                    
                    // Scroll to activity section after a brief delay
                    setTimeout(() => {
                        document.querySelector('.detail-column').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 100);
                }
            });
        }

        window.onload = () => {
            setTimeout(scrollToRight, 600);
            document.getElementById('prev-day').addEventListener('click', () => navigateDay(-1));
            document.getElementById('next-day').addEventListener('click', () => navigateDay(1));
            
            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                    navigateDay(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateDay(1);
                } else if (e.key === 'Escape') {
                    closeWrapped();
                }
            });
            
            // Pause carousel when page is hidden, resume when visible
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    if (carouselAutoRotate) {
                        clearInterval(carouselAutoRotate);
                        carouselAutoRotate = null;
                    }
                } else {
                    // Only restart if recent watches is expanded on mobile
                    if (window.innerWidth <= 768 && !recentWatchesExpanded) {
                        return;
                    }
                    startCarouselAutoRotate();
                }
            });
        };
        init();
    </script>
</body>
    
</html>
